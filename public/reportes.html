<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reportes - Cable Latín System</title>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Librería para generar EXCEL (.xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link rel="stylesheet" href="/public/css/sidebar.css" />
    <link rel="stylesheet" href="/Cablelatin/public/css/reportes.css" />
    <style>

        /* ======================================== */
/* VARIABLES GLOBALES (CSS sin cambios)   */
/* ======================================== */
:root {
    --color-principal: #0d6efd;
    --color-principal-hover: #0b5ed7;
    --color-texto: #212529;
    --color-texto-secundario: #6c757d;
    --color-fondo-claro: #f8f9fa;
    --color-fondo-panel: #ffffff;
    --color-borde: #dee2e6;
    
    --color-exito-ligero: #d1e7dd;
    --color-exito-oscuro: #0f5132;
    --color-error-ligero: #f8d7da;
    --color-error-oscuro: #842029;
    --color-pendiente-ligero: #fff3cd;
    --color-pendiente-oscuro: #664d03;
}

/* ======================================== */
/* ESTILOS GENERALES (CSS sin cambios)    */
/* ======================================== */
body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    margin: 0;
    background-color: var(--color-fondo-claro);
    color: var(--color-texto);
    line-height: 1.6;
    display: flex; /* Added to enable sidebar layout */
}

.main-content {
    flex-grow: 1; /* Allows main content to take remaining space */
    padding: 20px; /* Add some padding */
}

.container {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 2rem;
    background-color: var(--color-fondo-panel);
    border-radius: 0.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

h1 {
    color: var(--color-texto);
    margin-top: 0;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid var(--color-borde);
    padding-bottom: 0.5rem;
}

/* ======================================== */
/* CONTENEDOR DE FILTROS (CSS sin cambios) */
/* ======================================== */
.filtros-container {
    display: flex;
    flex-wrap: wrap; 
    gap: 1.5rem;
    margin-bottom: 2rem;
    align-items: flex-end; 
}

.filtro-grupo {
    display: flex;
    flex-direction: column;
    flex-grow: 1; 
}

.filtro-grupo label {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
    color: var(--color-texto-secundario);
}

.filtro-grupo input[type="date"] {
    padding: 0.65rem;
    border: 1px solid var(--color-borde);
    border-radius: 0.375rem;
    font-size: 0.95rem;
}

.filtro-grupo input[type="date"]:focus {
    border-color: var(--color-principal);
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    outline: none;
}

/* ======================================== */
/* BOTONES (CSS Modificado)              */
/* ======================================== */
.btn {
    padding: 0.65rem 1.25rem;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: background-color 0.3s, box-shadow 0.3s, opacity 0.3s;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn .icon {
    width: 18px;
    height: 18px;
}

/* Botón EXCEL (Verde) */
.btn-excel {
    background-color: var(--color-exito-oscuro);
    color: white;
}
.btn-excel:hover:not(:disabled) {
    background-color: #0c4128;
    box-shadow: 0 2px 8px rgba(15, 81, 50, 0.3);
}

/* ======================================== */
/* ESTILOS DE TABLA                       */
/* ======================================== */
.table-container {
    overflow-x: auto;
    margin-top: 2rem;
    border: 1px solid var(--color-borde);
    border-radius: 0.5rem;
}

table {
    width: 100%;
    border-collapse: collapse;
    text-align: left;
}

table th,
table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--color-borde);
}

table th {
    background-color: var(--color-fondo-claro);
    font-weight: 600;
    color: var(--color-texto-secundario);
    text-transform: uppercase;
    font-size: 0.85rem;
}

table tbody tr:hover {
    background-color: #f1f1f1;
}

/* ======================================== */
/* RESPONSIVIDAD (CSS sin cambios)        */
/* ======================================== */
@media (max-width: 768px) {
    .container {
        margin: 1rem;
        padding: 1rem;
    }

    .filtros-container {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch; 
    }

    .btn {
        width: 100%;
        justify-content: center;
    }
}
    </style>
     
    <style>
     :root {
--primary-color: #007bff;
--danger-color: #dc3545;
--secondary-color: #6c757d;
--success-color: #28a745;
--light-bg: #f8f9fa;
--card-bg: #ffffff;
--text-color: #333333;
--light-text-color: #666666;
--border-color: #e9ecef;
--sidebar-width: 250px;
}

/* === SIDEBAR === */
.sidebar {
width: var(--sidebar-width);
background-color: var(--card-bg);
box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
padding: 20px 0;
display: flex;
flex-direction: column;
border-right: 1px solid var(--border-color);
flex-shrink: 0;
transition: width 0.3s ease;
z-index: 100;
height: 100vh;
}

.sidebar-header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 0 20px 20px;
border-bottom: 1px solid var(--border-color);
margin-bottom: 20px;
}

.sidebar-header .logo {
display: flex;
align-items: center;
gap: 10px;
font-weight: 700;
font-size: 1.2em;
color: var(--primary-color);
white-space: nowrap;
}

.sidebar-header .logo i {
font-size: 1.5em;
}

.sidebar-header .sidebar-toggle-btn {
color: var(--secondary-color);
cursor: pointer;
font-size: 1.2em;
}

.sidebar-nav ul {
list-style: none;
padding: 0;
margin: 0;
width: 100%;
}

.sidebar-nav .nav-item {
display: flex;
align-items: center;
flex-wrap: wrap;
padding: 14px 20px;
color: var(--light-text-color);
cursor: pointer;
position: relative;
transition: all 0.3s ease;
white-space: nowrap;
overflow: hidden;
font-size: 0.95em;
}

.sidebar-nav .nav-item a {
color: inherit;
text-decoration: none;
display: flex;
align-items: center;
width: 100%;
}

.sidebar-nav .nav-item.active {
background-color: rgba(0, 123, 255, 0.1);
color: var(--primary-color);
border-left: 3px solid var(--primary-color);
padding-left: 17px;
font-weight: 500;
}

.sidebar-nav .nav-item:not(.active):hover {
background-color: rgba(0, 0, 0, 0.03);
}

.sidebar-nav .nav-item > i:first-child {
margin-right: 12px;
width: 20px;
font-size: 1.1em;
}

.sidebar-nav .nav-item > span {
flex-grow: 1;
}

.sidebar-nav .nav-item.has-submenu .arrow-icon {
margin-left: auto;
transition: transform 0.3s ease;
font-size: 0.8em;
}

.sidebar-nav .submenu {
list-style: none;
padding: 5px 0 5px 0;
margin: 0;
display: none;
width: 100%;
background-color: #fdfdfd;
}

.sidebar-nav .submenu li {
padding: 10px 20px 10px 52px;
color: var(--light-text-color);
font-size: 0.9em;
transition: all 0.2s ease;
}

.sidebar-nav .submenu li:hover {
color: var(--primary-color);
background-color: rgba(0, 123, 255, 0.05);
}

.sidebar-nav .nav-item.open > .submenu {
display: block;
}

.sidebar-nav .nav-item.open > .submenu-header .arrow-icon {
transform: rotate(90deg);
}

/* === MODO COLAPSABLE === */
.sidebar.collapsed {
width: 70px;
}

.sidebar.collapsed .sidebar-header .logo span,
.sidebar.collapsed .sidebar-nav span,
.sidebar.collapsed .submenu {
display: none;
}

.sidebar.collapsed .nav-item {
justify-content: center;
padding: 14px 0;
}

.sidebar.collapsed .nav-item i:first-child {
margin: 0;
}

/* === RESPONSIVE === */
@media (max-width: 768px) {
.sidebar {
    position: fixed;
    left: -250px;
    top: 0;
    height: 100vh;
    transition: left 0.3s ease;
}
.sidebar.active {
    left: 0;
}
}

    </style>


    <style>
         :root {
--primary-color: #007bff;
--danger-color: #dc3545;
--secondary-color: #6c757d;
--success-color: #28a745;
--light-bg: #f8f9fa;
--card-bg: #ffffff;
--text-color: #333333;
--light-text-color: #666666;
--border-color: #e9ecef;
--sidebar-width: 250px;
}

/* === SIDEBAR === */
.sidebar {
width: var(--sidebar-width);
background-color: var(--card-bg);
box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
padding: 20px 0;
display: flex;
flex-direction: column;
border-right: 1px solid var(--border-color);
flex-shrink: 0;
transition: width 0.3s ease;
z-index: 100;
height: 100vh;
}

.sidebar-header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 0 20px 20px;
border-bottom: 1px solid var(--border-color);
margin-bottom: 20px;
}

.sidebar-header .logo {
display: flex;
align-items: center;
gap: 10px;
font-weight: 700;
font-size: 1.2em;
color: var(--primary-color);
white-space: nowrap;
}

.sidebar-header .logo i {
font-size: 1.5em;
}

.sidebar-header .sidebar-toggle-btn {
color: var(--secondary-color);
cursor: pointer;
font-size: 1.2em;
}

.sidebar-nav ul {
list-style: none;
padding: 0;
margin: 0;
width: 100%;
}

.sidebar-nav .nav-item {
display: flex;
align-items: center;
flex-wrap: wrap;
padding: 14px 20px;
color: var(--light-text-color);
cursor: pointer;
position: relative;
transition: all 0.3s ease;
white-space: nowrap;
overflow: hidden;
font-size: 0.95em;
}

.sidebar-nav .nav-item a {
color: inherit;
text-decoration: none;
display: flex;
align-items: center;
width: 100%;
}

.sidebar-nav .nav-item.active {
background-color: rgba(0, 123, 255, 0.1);
color: var(--primary-color);
border-left: 3px solid var(--primary-color);
padding-left: 17px;
font-weight: 500;
}

.sidebar-nav .nav-item:not(.active):hover {
background-color: rgba(0, 0, 0, 0.03);
}

.sidebar-nav .nav-item > i:first-child {
margin-right: 12px;
width: 20px;
font-size: 1.1em;
}

.sidebar-nav .nav-item > span {
flex-grow: 1;
}

.sidebar-nav .nav-item.has-submenu .arrow-icon {
margin-left: auto;
transition: transform 0.3s ease;
font-size: 0.8em;
}

.sidebar-nav .submenu {
list-style: none;
padding: 5px 0 5px 0;
margin: 0;
display: none;
width: 100%;
background-color: #fdfdfd;
}

.sidebar-nav .submenu li {
padding: 10px 20px 10px 52px;
color: var(--light-text-color);
font-size: 0.9em;
transition: all 0.2s ease;
}

.sidebar-nav .submenu li:hover {
color: var(--primary-color);
background-color: rgba(0, 123, 255, 0.05);
}

.sidebar-nav .nav-item.open > .submenu {
display: block;
}

.sidebar-nav .nav-item.open > .submenu-header .arrow-icon {
transform: rotate(90deg);
}

/* === MODO COLAPSABLE === */
.sidebar.collapsed {
width: 70px;
}

.sidebar.collapsed .sidebar-header .logo span,
.sidebar.collapsed .sidebar-nav span,
.sidebar.collapsed .submenu {
display: none;
}

.sidebar.collapsed .nav-item {
justify-content: center;
padding: 14px 0;
}

.sidebar.collapsed .nav-item i:first-child {
margin: 0;
}

/* === RESPONSIVE === */
@media (max-width: 768px) {
.sidebar {
    position: fixed;
    left: -250px;
    top: 0;
    height: 100vh;
    transition: left 0.3s ease;
}
.sidebar.active {
    left: 0;
}
}
    </style>





    </head>
<body>
    <!-- Sidebar (Menú Lateral) -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="logo">
      <i class="fas fa-desktop"></i>
      <span>CABLE LATIN</span>
    </div>
    <i class="fas fa-bars sidebar-toggle-btn" id="sidebar-toggle-internal"></i>
  </div>

  <nav class="sidebar-nav">
    <ul>
      <!-- DASHBOARD -->
      <li class="nav-item">
        <a href="tablero.html">
          <i class="fas fa-grip"></i>
          <span>Dashboard</span>
        </a>
      </li>

      <!-- ADMINISTRACIÓN -->
      <li class="nav-item has-submenu">
        <div class="submenu-header">
          <i class="fas fa-gear"></i>
          <span>Administración</span>
          <i class="fas fa-chevron-right arrow-icon"></i>
        </div>
        <ul class="submenu">
          <li><a href="usuario.html">Usuarios</a></li>
          <li><a href="planes.html">Planes y servicios</a></li>
        </ul>
      </li>

      <!-- CLIENTES -->
      <li class="nav-item has-submenu">
        <div class="submenu-header">
          <i class="fas fa-users"></i>
          <span>Clientes</span>
          <i class="fas fa-chevron-right arrow-icon"></i>
        </div>
        <ul class="submenu">
          <li><a href="clientes.html">Clientes</a></li>
          <li><a href="facturas.html">Facturas</a></li>
          <li><a href="pagos.html">Pagos</a></li>
        </ul>
      </li>

      <!-- REPORTES -->
      <li class="nav-item has-submenu">
        <div class="submenu-header">
          <i class="fas fa-list-check"></i>
          <span>Reportes</span>
          <i class="fas fa-chevron-right arrow-icon"></i>
        </div>
        <ul class="submenu">
          <li><a href="reportes.html">Reportes</a></li>
        </ul>
      </li>

      <!-- PERFIL -->
      <li class="nav-item">
        <a href="perfil.html">
          <i class="fas fa-user-circle"></i>
          <span>Mi Perfil</span>
        </a>
      </li>

      <!-- CERRAR SESIÓN -->
      <li class="nav-item">
        <a href="login.html">
          <i class="fa-solid fa-door-open"></i>
          <span>Cerrar Sesión</span>
        </a>
      </li>
    </ul>
  </nav>
</aside>

    <div class="main-content">
        <main class="container">
            <h1>Gestión de Reportes</h1>

            <div class="filtros-container">
                <div class="filtro-grupo">
                    <label for="fechaDesde">Filtrar Desde</label>
                    <input type="date" id="fechaDesde" />
                </div>

                <div class="filtro-grupo">
                    <label for="fechaHasta">Filtrar Hasta</label>
                    <input type="date" id="fechaHasta" />
                </div>
                
                <!-- Botón EXCEL (ÚNICO BOTÓN) -->
                <button id="btnGenerarExcel" class="btn btn-excel" disabled>
                    <i data-lucide="loader" class="icon icon-loader" id="loader-icon"></i>
                    <i data-lucide="file-spreadsheet" class="icon icon-ready" id="excel-icon" style="display: none;"></i>
                    <span id="btn-excel-text">Cargando datos...</span>
                </button>
            </div>

            <div class="table-container">
                <table id="reportes-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Descripción</th>
                            <th>Cliente ID</th>
                            <th>Creado En</th>
                        </tr>
                    </thead>
                    <tbody id="reportes-table-body">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px;">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </main>
    </div>
    

    <script>
      // Submenús desplegables
document.querySelectorAll(".has-submenu").forEach((item) => {
  const header = item.querySelector(".submenu-header");
  header.addEventListener("click", () => {
    item.classList.toggle("open");
  });
});

// Botón para colapsar/expandir sidebar
const toggleBtn = document.getElementById("sidebar-toggle-internal");
if (toggleBtn) {
  toggleBtn.addEventListener("click", () => {
    document.getElementById("sidebar").classList.toggle("collapsed");
  });
}

    </script>
    <script type="module">
      // --- Importaciones de Firebase ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { 
    getFirestore, 
    collection, 
    onSnapshot 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- Configuración Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyDHrAEU4HI2onL1bRZpRfB5GAbsbD6_XBE",
  authDomain: "cablelatin-prueba.firebaseapp.com",
  projectId: "cablelatin-prueba",
  storageBucket: "cablelatin-prueba.firebasestorage.app",
  messagingSenderId: "370823325775",
  appId: "1:370823325775:web:cbd9142e612bc0a979623a",
  measurementId: "G-PV3NRMJBW2"
};

// --- Variables Globales ---
const appId = firebaseConfig.projectId;
let app, auth, db;
let userId = null;

// Almacenes de datos globales
let allClientes = [];
let allServicios = [];
let allPagos = [];
let allReportes = [];

// Estado de carga
const loadStatus = {
    clientes: false,
    servicios: false,
    pagos: false,
    reportes: false
};

// --- Referencias a Elementos DOM ---
const btnGenerarExcel = document.getElementById('btnGenerarExcel');
const fechaDesdeInput = document.getElementById('fechaDesde');
const fechaHastaInput = document.getElementById('fechaHasta');
const loaderIcon = document.getElementById('loader-icon');
const excelIcon = document.getElementById('excel-icon');
const btnExcelText = document.getElementById('btn-excel-text');

// Objetos de librerías
const XLSX = window.XLSX;

// --- Inicialización Firebase ---
try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    console.log("Firebase inicializado");
    initAuth();
} catch (e) {
    console.error("Error inicializando Firebase:", e);
    btnExcelText.textContent = "Error de Conexión";
}

// --- Autenticación ---
function initAuth() {
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userId = user.uid;
            console.log("Autenticado:", userId);
            
            // Empezar a cargar todas las colecciones
            loadAllCollections();

        } else {
            console.log("No autenticado, intentando anónimo...");
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Error auth anónima:", error);
            }
        }
    });
}

/**
 * Inicia la carga de todas las colecciones de datos
 */
function loadAllCollections() {
    if (!userId) return;

    // Definir las 4 referencias
    const clientesRef = collection(db, 'artifacts', appId, 'public', 'data', 'clientes');
    const serviciosRef = collection(db, 'artifacts', appId, 'public', 'data', 'servicios_clientes');
    const pagosRef = collection(db, 'artifacts', appId, 'public', 'data', 'pagos');
    const reportesRef = collection(db, 'artifacts', appId, 'public', 'data', 'reportes_tecnicos');

    // Iniciar los 4 "listeners"
    listenForData(clientesRef, allClientes, "clientes", "Clientes");
    listenForData(serviciosRef, allServicios, "servicios", "Servicios");
    listenForData(pagosRef, allPagos, "pagos", "Pagos");
    listenForData(reportesRef, allReportes, "reportes", "Reportes Técnicos");
}

/**
 * Función genérica para escuchar una colección y llenar un array
 */
function listenForData(collectionRef, targetArray, statusKey, logName) {
    onSnapshot(collectionRef, (snapshot) => {
        targetArray.length = 0; // Limpiar el array
        snapshot.forEach(doc => {
            targetArray.push({ id: doc.id, ...doc.data() });
        });
        console.log(`${logName} cargados: ${targetArray.length}`);
        
        // Marcar como cargado y revisar si ya terminamos
        loadStatus[statusKey] = true;
        checkAllDataLoaded();
        
    }, (error) => {
        console.error(`Error al cargar ${logName}:`, error);
        // Marcar como cargado (incluso con error) para no bloquear el botón
        loadStatus[statusKey] = true;
        checkAllDataLoaded();
    });
}

/**
 * Revisa si las 4 colecciones ya respondieron (con datos o vacías)
 */
function checkAllDataLoaded() {
    if (loadStatus.clientes && loadStatus.servicios && loadStatus.pagos && loadStatus.reportes) {
        console.log("Toda la data ha sido cargada.");
        btnGenerarExcel.disabled = false;
        btnExcelText.textContent = "Generar Excel";
        loaderIcon.style.display = 'none';
        excelIcon.style.display = 'inline-block';
    }
}

/**
 * Función de ayuda para filtrar un array por un campo de fecha
 */
function filterDataByDate(data, dateField, startDate, endDate) {
    // Si no hay fechas, devolver todos los datos
    if (!startDate || !endDate) {
        return data;
    }

    try {
        const start = new Date(startDate + 'T00:00:00');
        const end = new Date(endDate + 'T23:59:59');

        if (start > end) {
            return data; // Si el rango es inválido, devolver todo
        }

        return data.filter(item => {
            const itemDateStr = item[dateField];
            if (!itemDateStr) return false; // No incluir si no tiene fecha
            
            // Asegurarse que la fecha sea válida antes de crear el objeto Date
            // Modificado: Acepta Timestamp o string YYYY-MM-DD
            let itemDate;
            if (itemDateStr && typeof itemDateStr.seconds === 'number') { // Es Timestamp
                 itemDate = new Date(itemDateStr.seconds * 1000);
            } else if (typeof itemDateStr === 'string' && itemDateStr.length >= 10) { // Es String
                 itemDate = new Date(itemDateStr.substring(0, 10) + 'T00:00:00');
            } else {
                 return false; // Formato no reconocido
            }
            
            // Ajustar la fecha del item a medianoche para comparar solo días
            itemDate.setHours(0, 0, 0, 0); 
            
            return itemDate >= start && itemDate <= end;
        });
    } catch (e) {
        console.error("Error al filtrar fechas:", e);
        return data; // Devolver todo si hay error
    }
}

/**
 * ¡NUEVO!
 * Función de ayuda para convertir un objeto Timestamp de Firebase
 * en un string de fecha legible (YYYY-MM-DD).
 */
function formatTimestamp(timestamp) {
    if (!timestamp) return 'N/A'; // Devuelve 'N/A' si es null o undefined

    // Si ya es un string de fecha (como '2025-10-26'), devolverlo tal cual.
    if (typeof timestamp === 'string' && /^\d{4}-\d{2}-\d{2}/.test(timestamp)) {
        return timestamp.substring(0, 10);
    }
    
    // Si es un objeto Timestamp de Firebase
    if (typeof timestamp.seconds === 'number') {
        try {
            // Multiplicar por 1000 para convertir segundos a milisegundos
            const date = new Date(timestamp.seconds * 1000);
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        } catch (e) {
            console.error("Error formateando timestamp:", timestamp, e);
            return 'Error Fecha';
        }
    }
    
    // Si no es ninguno de los anteriores, devolver 'N/A' o intentar interpretar
    console.warn("Formato de fecha no reconocido en formatTimestamp:", timestamp);
    return 'Fecha Inválida'; 
}


// ========================================
//    EVENT LISTENER: GENERAR EXCEL
// ========================================
btnGenerarExcel.addEventListener('click', () => {
    console.log("Iniciando generación de Excel...");
    
    // Poner el botón en estado de "cargando"
    btnGenerarExcel.disabled = true;
    btnExcelText.textContent = "Generando...";
    loaderIcon.style.display = 'inline-block';
    excelIcon.style.display = 'none';

    // Obtener las fechas de los filtros
    const fechaDesde = fechaDesdeInput.value;
    const fechaHasta = fechaHastaInput.value;
    
    // Usamos setTimeout para que la UI se actualice (muestre "Generando...")
    // antes de que el procesador se bloquee creando el Excel.
    setTimeout(() => {
        try {
            // 1. Crear el "Libro" (Workbook)
            const wb = XLSX.utils.book_new();

            // 2. Filtrar y añadir las hojas
            
            // Hoja 1: Clientes (sin filtro de fecha, pero con fecha_registro formateada)
            const dataClientes = allClientes.map(c => ({
                ...c,
                fecha_registro: formatTimestamp(c.fecha_registro) // Usar la función de formato
            }));
            const wsClientes = XLSX.utils.json_to_sheet(dataClientes);
            XLSX.utils.book_append_sheet(wb, wsClientes, "Clientes");
            
            
            // Hoja 2: Servicios (filtrado por 'fecha_inicio' Y fecha_creacion formateada)
            const dataServiciosRaw = filterDataByDate(allServicios, 'fecha_inicio', fechaDesde, fechaHasta);
            const dataServicios = dataServiciosRaw.map(s => ({
                ...s,
                fecha_creacion: formatTimestamp(s.fecha_creacion), // Usar la función de formato
                fecha_inicio: formatTimestamp(s.fecha_inicio)   // Formatear también fecha_inicio
            }));
            const wsServicios = XLSX.utils.json_to_sheet(dataServicios);
            XLSX.utils.book_append_sheet(wb, wsServicios, "Servicios");

            
            // Hoja 3: Pagos (filtrado por 'fecha_pago' Y creado_en formateado)
            const dataPagosRaw = filterDataByDate(allPagos, 'fecha_pago', fechaDesde, fechaHasta);
            const dataPagos = dataPagosRaw.map(p => ({
                ...p,
                creado_en: formatTimestamp(p.creado_en), // Usar la función de formato
                fecha_pago: formatTimestamp(p.fecha_pago) // Formatear también fecha_pago
            }));
            const wsPagos = XLSX.utils.json_to_sheet(dataPagos);
            XLSX.utils.book_append_sheet(wb, wsPagos, "Pagos");
            
            
            // Hoja 4: Reportes Técnicos (filtrado por 'fecha' Y creado_en formateado)
            const dataReportesRaw = filterDataByDate(allReportes, 'fecha', fechaDesde, fechaHasta);
            const dataReportes = dataReportesRaw.map(r => ({
                ...r,
                // Asumimos que la fecha de registro se llama 'creado_en'
                creado_en: formatTimestamp(r.creado_en), // Usar la función de formato
                fecha: formatTimestamp(r.fecha) // Formatear también 'fecha'
            }));
            const wsReportes = XLSX.utils.json_to_sheet(dataReportes);
            XLSX.utils.book_append_sheet(wb, wsReportes, "Reportes Tecnicos");

            // 3. Descargar el archivo
            const nombreArchivo = `Reporte_Total_CableLatin_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, nombreArchivo);
            
            console.log("Excel generado y descargado.");

        } catch (error) {
            console.error("Error al generar el Excel:", error);
            alert("Ocurrió un error al generar el archivo Excel.");
        } finally {
            // Restaurar el botón
            btnGenerarExcel.disabled = false;
            btnExcelText.textContent = "Generar Excel";
            loaderIcon.style.display = 'none';
            excelIcon.style.display = 'inline-block';
        }
    }, 50); // 50ms de espera para actualizar la UI
});


// ========================================
//   CARGA INICIAL
// ========================================
// Activa los íconos de Lucide
lucide.createIcons();
// Animamos el loader al inicio
const loader = document.getElementById('loader-icon');
if (loader) {
    loader.animate([
        { transform: 'rotate(0deg)' },
        { transform: 'rotate(360deg)' }
    ], {
        duration: 4000, // Duración más lenta para que se note
        iterations: Infinity
    });
}
    </script>
</body>


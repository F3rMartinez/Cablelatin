<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Clientes</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Lucide Icons (Necesario si sidebar.html los usa) -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Asegúrate que la ruta a tu CSS sea correcta -->
        <link rel="stylesheet" href="/css/clientes.css">
        <link rel="stylesheet" href="/css/sidebar.css">


    <!-- Estilos básicos integrados (Mueve a tu CSS si prefieres) -->
</head>
<body>
    
    <!-- Sidebar (Menú Lateral) -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="logo">
      <i class="fas fa-desktop"></i>
      <span>CABLE LATIN</span>
    </div>
    <i class="fas fa-bars sidebar-toggle-btn" id="sidebar-toggle-internal"></i>
  </div>

  <nav class="sidebar-nav">
    <ul>
      <!-- DASHBOARD -->
      <li class="nav-item">
        <a href="tablero.html">
          <i class="fas fa-grip"></i>
          <span>Dashboard</span>
        </a>
      </li>

      <!-- ADMINISTRACIÓN -->
      <li class="nav-item has-submenu">
        <div class="submenu-header">
          <i class="fas fa-gear"></i>
          <span>Administración</span>
          <i class="fas fa-chevron-right arrow-icon"></i>
        </div>
        <ul class="submenu">
          <li><a href="usuario.html">Usuarios</a></li>
          <li><a href="planes.html">Planes y servicios</a></li>
        </ul>
      </li>

      <!-- CLIENTES -->
      <li class="nav-item has-submenu">
        <div class="submenu-header">
          <i class="fas fa-users"></i>
          <span>Clientes</span>
          <i class="fas fa-chevron-right arrow-icon"></i>
        </div>
        <ul class="submenu">
          <li><a href="clientes.html">Clientes</a></li>
          <li><a href="facturas.html">Facturas</a></li>
          <li><a href="pagos.html">Pagos</a></li>
        </ul>
      </li>

      <!-- REPORTES -->
      <li class="nav-item has-submenu">
        <div class="submenu-header">
          <i class="fas fa-list-check"></i>
          <span>Reportes</span>
          <i class="fas fa-chevron-right arrow-icon"></i>
        </div>
        <ul class="submenu">
          <li><a href="reportes.html">Reportes</a></li>
        </ul>
      </li>

      <!-- PERFIL -->
      <li class="nav-item">
        <a href="perfil.html">
          <i class="fas fa-user-circle"></i>
          <span>Mi Perfil</span>
        </a>
      </li>

      <!-- CERRAR SESIÓN -->
      <li class="nav-item">
        <a href="login.html">
          <i class="fa-solid fa-door-open"></i>
          <span>Cerrar Sesión</span>
        </a>
      </li>
    </ul>
  </nav>
</aside>

    <main class="main-content">
        
        <header class="main-navbar">
             <button id="sidebar-toggle-main" class="sidebar-toggle-btn">
                 <i class="fas fa-bars"></i>
             </button>
             <h1 style="font-size: 1.2rem; margin: 0; font-weight: 500;">Gestión de Clientes</h1>
        </header>

        <div class="content-body">
            <div class="card-table-wrapper">

                <div class="content-header">
                    <h1>Clientes Registrados</h1>
                    <a href="registrar_cliente.html" class="btn btn-primary" title="Añadir Nuevo Cliente">
                        <i class="fas fa-plus"></i> Añadir Cliente
                    </a>
                </div>

                <div class="table-controls">
                    <div>
                        <label for="show-entries">Mostrar</label>
                        <select id="show-entries" name="show-entries">
                            <option value="10" selected>10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                        registros
                    </div>
                    <div>
                        <label for="search-table">Buscar:</label>
                        <input type="search" id="search-table" placeholder="Nombre, Apellido o DNI...">
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Id Cliente</th> 
                                <th>Foto</th>
                                <th>DNI / RUC</th> 
                                <th>Nombre Completo</th> 
                                <th>Teléfono</th>
                                <th>Dirección</th> 
                                <th>Estado Cliente</th> 
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table-body">
                             <tr><td colspan="8" style="text-align: center; padding: 30px; color: #6c757d;"><i class="fas fa-spinner fa-spin"></i> Cargando clientes...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="table-footer">
                    <span id="footer-info" class="footer-info">Mostrando 0 de 0 registros</span>
                    <nav id="pagination" class="pagination">
                        <!-- Paginación se generará dinámicamente -->
                        <a href="#" class="page-link disabled" data-action="prev">Anterior</a>
                        <span id="page-numbers"></span> <!-- Números de página aquí -->
                        <a href="#" class="page-link" data-action="next">Siguiente</a>
                    </nav>
                </div>
            </div>
        </div>
    </main>
    
    <!-- ======================= MODALES ======================= -->

    <!-- Modal Editar Cliente -->
    <div id="modal-editar-cliente" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('modal-editar-cliente')">&times;</button>
            <h2>Editar Datos del Cliente</h2>
            <form id="form-editar-cliente">
                <input type="hidden" id="edit-cliente-id" name="id"> 
                <div class="modal-form-grid">
                    <div class="form-group full-width">
                        <label>Tipo de Cliente:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="tipo_cliente" value="Residencia" checked> Residencia / Personal</label>
                            <label><input type="radio" name="tipo_cliente" value="Empresarial"> Empresarial (RUC)</label>
                        </div>
                    </div>
                    <div class="form-group"><label for="edit-nombre">Nombres:</label><input type="text" id="edit-nombre" name="nombre" required></div>
                    <div class="form-group"><label for="edit-apellido">Apellidos:</label><input type="text" id="edit-apellido" name="apellido" required></div>
                    <div class="form-group"><label for="edit-dni">DNI / RUC:</label><input type="text" id="edit-dni" name="dni" required></div> 
                    <div class="form-group"><label for="edit-email">Correo Electrónico:</label><input type="email" id="edit-email" name="correo"></div>
                    <div class="form-group"><label for="edit-telefono">Teléfono / Celular:</label><input type="tel" id="edit-telefono" name="telefono"></div>
                     <div class="form-group"><label for="edit-estado-cliente">Estado del Cliente:</label>
                         <select id="edit-estado-cliente" name="estado">
                             <option value="Activo">Activo</option>
                             <option value="Inactivo">Inactivo</option>
                             <option value="Suspendido">Suspendido</option>
                         </select>
                     </div>
                    <div class="form-group full-width"><label for="edit-direccion">Dirección Completa:</label><input type="text" id="edit-direccion" name="direccion"></div>
                    <div class="form-group full-width"><label for="edit-referencia">Referencia / Notas:</label><textarea id="edit-referencia" name="referencia" rows="3"></textarea></div>
                    
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('modal-editar-cliente')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios Cliente</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Servicio -->
    <div id="modal-editar-servicio" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('modal-editar-servicio')">&times;</button>
            <h2>Editar Asignación de Servicio</h2>
            <form id="form-editar-servicio">
                <input type="hidden" id="edit-servicio-doc-id" name="servicioDocId"> 
                <input type="hidden" id="edit-servicio-cliente-id" name="clienteId"> 
                
                 <p style="text-align: left; margin: -10px 0 20px 0; font-size: 0.9rem; color: #555;">Editando servicio para: <strong id="edit-servicio-nombre-cliente"></strong></p>

                <div class="modal-form-grid">
                    <div class="form-group">
                        <label for="edit-plan-tipo">Tipo de Plan:</label>
                        <select id="edit-plan-tipo" name="id_plan" required>
                             <option value="">Cargando planes...</option> 
                        </select>
                    </div>
                     <div class="form-group">
                         <label for="edit-precio-plan">Precio Actual Plan (S/):</label>
                         <input type="number" id="edit-precio-plan" name="precioPlanActual" step="0.01" readonly style="background-color: #e9ecef; color: #555;">
                     </div>
                    <div class="form-group">
                        <label for="edit-servicios-adicionales">Servicios Adicionales:</label>
                        <select id="edit-servicios-adicionales" name="servicios_adicionales">
                            <option value="Ninguno">Ninguno</option>
                            <option value="HBO">HBO Premium</option>
                            <option value="FOX">FOX Sports Pack</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-costo-adicional">Costo Adicional (S/):</label>
                        <input type="number" id="edit-costo-adicional" name="costo_adicional" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="edit-fecha-inicio">Fecha de Inicio:</label>
                        <input type="date" id="edit-fecha-inicio" name="fecha_inicio" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-ciclo-facturacion">Día de Facturación:</label>
                        <input type="number" id="edit-ciclo-facturacion" name="ciclo_facturacion" min="1" max="31">
                    </div>
                    <div class="form-group">
                        <label for="edit-estado-servicio">Estado del Servicio:</label>
                        <select id="edit-estado-servicio" name="estado">
                            <option value="Instalacion">Pendiente Instalación</option>
                            <option value="Activo">Activo</option>
                            <option value="Pendiente Pago">Pendiente Pago</option>
                            <option value="Suspendido">Suspendido</option>
                            <option value="Cortado">Cortado</option>
                        </select>
                    </div>
                     <div></div> <!-- Placeholder si es necesario alinear -->

                    <div class="form-group full-width">
                        <label for="edit-observaciones-tecnicas">Observaciones Técnicas:</label>
                        <textarea id="edit-observaciones-tecnicas" name="observaciones" rows="3"></textarea>
                    </div>
                    
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('modal-editar-servicio')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios Servicio</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Confirmación -->
    <div id="modal-confirm" class="modal-overlay">
        <div class="modal-content notification-confirm">
            <div class="notification-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="notification-title" id="confirm-title">Confirmar Acción</div>
            <div class="notification-message" id="confirm-message">¿Está seguro?</div>
            <div class="notification-buttons">
                <button type="button" class="btn btn-secondary btn-cancel" onclick="closeModal('modal-confirm')">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirm-action-button">Confirmar</button> 
            </div>
        </div>
    </div>

    <!-- Modal Notificación (Éxito/Error) -->
    <div id="modal-notification" class="modal-overlay">
         <!-- El contenido (éxito o error) se inyectará dinámicamente -->
    </div>

    <!-- ======================= SCRIPT ======================= -->
        <script type="module">
            // --- Importaciones Firebase ---
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
            import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, query, where, getDocs, orderBy, limit, startAfter, endBefore, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
            // --- Configuración Firebase ---
             const firebaseConfig = {
                apiKey: "AIzaSyDHrAEU4HI2onL1bRZpRfB5GAbsbD6_XBE", 
                authDomain: "cablelatin-prueba.firebaseapp.com",
                projectId: "cablelatin-prueba",
                storageBucket: "cablelatin-prueba.firebasestorage.app",
                messagingSenderId: "370823325775",
                appId: "1:370823325775:web:cbd9142e612bc0a979623a",
                measurementId: "G-PV3NRMJBW2"
            };
            const appId = firebaseConfig.projectId;
    
            // --- Variables Globales ---
            let app, auth, db, analytics;
            let userId = null;
            let isAuthReady = false;
            let unsubscribeClients = null; 
            let availablePlans = []; 
            let allClientsData = []; // Guardar todos los clientes para filtrar/paginar
            let filteredClients = []; // Clientes después de aplicar búsqueda
            let currentPage = 1;
            let itemsPerPage = 10; // Valor inicial del select
            
            // --- Referencias DOM ---
            const clientsTableBody = document.getElementById('clients-table-body');
            const footerInfo = document.getElementById('footer-info');
            const modalNotification = document.getElementById('modal-notification');
            const modalConfirm = document.getElementById('modal-confirm');
            const confirmActionButton = document.getElementById('confirm-action-button');
            const searchInput = document.getElementById('search-table');
            const showEntriesSelect = document.getElementById('show-entries');
            const paginationContainer = document.getElementById('pagination');
            let currentDeleteClientId = null; 
    
            // --- Funciones de Utilidad (Modales, Notificaciones, Sidebar) ---
            window.openModal = (modalId) => { /* Misma función */ 
                const modal = document.getElementById(modalId);
                if(modal) { modal.style.display = 'flex'; setTimeout(() => modal.classList.add('open'), 10); }
            };
            window.closeModal = (modalId) => { /* Misma función */ 
                 const modal = document.getElementById(modalId);
                 if(modal) { modal.classList.remove('open'); setTimeout(() => modal.style.display = 'none', 300); }
                 // Limpiar listener de confirmación si cerramos ese modal (SIN REEMPLAZAR NODO)
                 if (modalId === 'modal-confirm' && confirmActionButton) {
                     confirmActionButton.onclick = null; // Simplemente quitar el listener
                 }
            };
    
            function showNotification(type, title, message) { /* Misma función */ 
                 if (!modalNotification) return;
                 const isSuccess = type === 'success';
                 const iconClass = isSuccess ? 'fa-check-circle' : 'fa-exclamation-triangle'; // Error o Success
                 const colorClass = isSuccess ? 'var(--success-color)' : 'var(--danger-color)';
                 const btnClass = isSuccess ? 'btn-primary' : 'btn-danger';
                 modalNotification.innerHTML = `
                     <div class="modal-content ${isSuccess ? 'notification-success' : 'notification-error'}">
                         <div class="notification-icon" style="color: ${colorClass};"><i class="fas ${iconClass}"></i></div>
                         <div class="notification-title">${title}</div>
                         <div class="notification-message">${message}</div>
                         <div class="notification-buttons">
                             <button type="button" class="btn ${btnClass}" onclick="closeModal('modal-notification')">Aceptar</button>
                         </div>
                     </div>`;
                 openModal('modal-notification');
            }
            
    
    
            // --- Inicialización Firebase y Auth ---
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                analytics = getAnalytics(app); // Opcional
                console.log("Firebase inicializado:", appId);
    
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; isAuthReady = true;
                        console.log("Autenticado:", userId);
                        listenForClients(); 
                        loadPlansForEditModal(); 
                    } else {
                        isAuthReady = false; userId = null;
                        if(unsubscribeClients) unsubscribeClients(); 
                        renderClientsTable([]); // Mostrar tabla vacía
                         clientsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: red;">Inicie sesión para ver clientes.</td></tr>';
                        console.log("No autenticado, intentando anónimo...");
                         signInAnonymously(auth).catch(error => { 
                             console.error("Error auth anónima:", error);
                             showNotification('error', 'Error Autenticación', 'No se pudo iniciar sesión.');
                         });
                    }
                });
            } catch (e) {
                console.error("Error inicializando Firebase:", e);
                 if(clientsTableBody) clientsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Error crítico al conectar con Firebase.</td></tr>';
            }
    
            // --- Cargar Clientes (Real-time) ---
            function listenForClients() {
                if (!isAuthReady || !db || !userId) return;
                if (unsubscribeClients) unsubscribeClients(); 
    
                const clientsRef = collection(db, 'artifacts', appId, 'public', 'data', 'clientes');
                // Ordenar por fecha de registro descendente por defecto
                const q = query(clientsRef, orderBy("fecha_registro", "desc")); 
    
                unsubscribeClients = onSnapshot(q, (snapshot) => {
                    allClientsData = []; // Resetear datos completos
                    snapshot.forEach(doc => {
                        allClientsData.push({ id: doc.id, ...doc.data() });
                    });
                    applyFiltersAndRender(); // Aplicar filtros (búsqueda) y renderizar
                }, (error) => {
                    console.error("Error al escuchar clientes:", error);
                    allClientsData = []; filteredClients = []; renderClientsTable([]); // Limpiar datos y tabla
                    showNotification('error', 'Error de Carga', `No se pudieron cargar los clientes: ${error.message}`);
                });
            }
    
            // --- Filtrar y Renderizar Tabla con Paginación ---
            function applyFiltersAndRender() {
                const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
    
                // Filtrar basado en la búsqueda
                filteredClients = allClientsData.filter(client => {
                    const nombreCompleto = `${client.nombre || ''} ${client.apellido || ''}`.toLowerCase();
                    const dni = (client.dni || '').toLowerCase();
                    return nombreCompleto.includes(searchTerm) || dni.includes(searchTerm);
                });
                
                currentPage = 1; // Resetear a la primera página con nuevos filtros
                renderCurrentPage();
            }
    
            function renderCurrentPage() {
                if (!clientsTableBody) return;
    
                itemsPerPage = showEntriesSelect ? parseInt(showEntriesSelect.value, 10) : 10;
                const totalItems = filteredClients.length;
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                currentPage = Math.max(1, Math.min(currentPage, totalPages)); // Asegurar que la página sea válida
    
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const clientsToRender = filteredClients.slice(startIndex, endIndex);
    
                clientsTableBody.innerHTML = ''; // Limpiar
    
                if (clientsToRender.length === 0) {
                    const message = searchInput?.value ? 'No se encontraron clientes con ese criterio.' : 'No hay clientes registrados.';
                    clientsTableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 30px; color: #6c757d;">${message}</td></tr>`;
                } else {
                    clientsToRender.forEach(client => {
                        const row = clientsTableBody.insertRow();
                        const escape = (str) => str ? String(str).replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
                        const nombreCompleto = `${escape(client.apellido || '')}, ${escape(client.nombre || '')}`.trim() === ',' ? 'N/A' : `${escape(client.apellido || '')}, ${escape(client.nombre || '')}`;
                        
                        let estadoClass = 'inactivo'; // Default gris
                        const clientState = client.estado?.toLowerCase();
                         if (clientState === 'activo') estadoClass = 'activo';
                         else if (clientState === 'suspendido') estadoClass = 'suspendido';
                         // Añadir más clases si es necesario para otros estados
    
                        // Usar JSON.stringify para pasar el objeto completo de forma segura
                        const clientDataJson = JSON.stringify(client).replace(/"/g, '&quot;');
    
                        row.innerHTML = `
                            <td>${escape(client.id?.substring(0, 8) || 'N/A')}...</td>
                            <td><div class="user-photo-placeholder"><i class="fas fa-user"></i></div></td>
                            <td>${escape(client.dni || 'N/A')}</td>
                            <td>${nombreCompleto}</td>
                            <td>${escape(client.telefono || 'N/A')}</td>
                            <td>${escape(client.direccion?.substring(0, 30) || 'N/A')}${client.direccion?.length > 30 ? '...' : ''}</td>
                            <td><span class="status-pill ${estadoClass}">${escape(client.estado || 'N/A')}</span></td>
                            <td class="table-actions">
                                <button class="btn-icon edit" title="Editar Cliente" onclick='openEditClientModal(${clientDataJson})'><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn-icon service" title="Editar Servicio" onclick='openEditServiceModal("${escape(client.id)}", "${escape(nombreCompleto)}")'><i class="fas fa-wifi"></i></button>
                                <button class="btn-icon delete" title="Eliminar Cliente" onclick='confirmDeleteClient("${escape(client.id)}", "${escape(nombreCompleto)}")'><i class="fas fa-trash-alt"></i></button>
                            </td>
                        `;
                    });
                }
                 renderPagination(totalItems, totalPages);
            }
            
            // --- Renderizar Paginación ---
            function renderPagination(totalItems, totalPages) {
                if (!footerInfo || !paginationContainer) return;
    
                 const startItem = totalItems === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
                 const endItem = Math.min(currentPage * itemsPerPage, totalItems);
                 footerInfo.textContent = `Mostrando ${startItem} a ${endItem} de ${totalItems} registros`;
    
                 const pageNumbersContainer = paginationContainer.querySelector('#page-numbers');
                 const prevLink = paginationContainer.querySelector('[data-action="prev"]');
                 const nextLink = paginationContainer.querySelector('[data-action="next"]');
                 if(!pageNumbersContainer || !prevLink || !nextLink) return;
    
                 pageNumbersContainer.innerHTML = ''; // Limpiar números
    
                 // Lógica simple de paginación (ej: mostrar actual y +/- 1) - Mejora si necesitas más números
                 const maxPagesToShow = 5; 
                 let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
                 let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
                 
                 // Ajustar si estamos cerca del final
                 if(endPage - startPage + 1 < maxPagesToShow) {
                     startPage = Math.max(1, endPage - maxPagesToShow + 1);
                 }
    
    
                 if (startPage > 1) {
                     const firstLink = createPageLink(1);
                     pageNumbersContainer.appendChild(firstLink);
                     if (startPage > 2) pageNumbersContainer.appendChild(createPageEllipsis());
                 }
    
                 for (let i = startPage; i <= endPage; i++) {
                     const pageLink = createPageLink(i);
                     if (i === currentPage) pageLink.classList.add('active');
                     pageNumbersContainer.appendChild(pageLink);
                 }
    
                 if (endPage < totalPages) {
                     if (endPage < totalPages - 1) pageNumbersContainer.appendChild(createPageEllipsis());
                     const lastLink = createPageLink(totalPages);
                     pageNumbersContainer.appendChild(lastLink);
                 }
    
    
                 // Habilitar/deshabilitar Anterior/Siguiente
                 prevLink.classList.toggle('disabled', currentPage === 1);
                 nextLink.classList.toggle('disabled', currentPage === totalPages || totalPages === 0);
    
                 // Asignar eventos a los links de paginación (rehacer para evitar duplicados)
                 paginationContainer.querySelectorAll('.page-link').forEach(link => {
                     // Clonar y reemplazar para limpiar listeners viejos
                     const newLink = link.cloneNode(true);
                     link.parentNode.replaceChild(newLink, link);
                     
                     if (!newLink.classList.contains('disabled') && !newLink.classList.contains('ellipsis')) {
                          newLink.addEventListener('click', (e) => {
                             e.preventDefault();
                             const action = newLink.dataset.action;
                             const page = newLink.dataset.page;
                             if (action === 'prev') {
                                 currentPage--;
                             } else if (action === 'next') {
                                 currentPage++;
                             } else if (page) {
                                 currentPage = parseInt(page, 10);
                             }
                             renderCurrentPage(); // Volver a renderizar
                         });
                     }
                 });
            }
            
            function createPageLink(pageNumber) {
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = pageNumber;
                a.classList.add('page-link');
                a.dataset.page = pageNumber;
                return a;
            }
             function createPageEllipsis() {
                 const span = document.createElement('span');
                 span.textContent = '...';
                 span.classList.add('ellipsis'); // Clase para posible estilo
                 span.style.padding = '6px 10px';
                 span.style.color = '#6c757d';
                 return span;
             }
    
    
            // --- Lógica Modal Editar Cliente ---
            window.openEditClientModal = (clientData) => { /* Misma función */ 
                 if (typeof clientData === 'string') {
                     try { clientData = JSON.parse(clientData.replace(/&quot;/g, '"')); } 
                     catch (e) { console.error("Error parsing client data:", e); return; }
                 }
                const form = document.getElementById('form-editar-cliente');
                if (!form || !clientData) return;
                form.reset(); 
                form.id.value = clientData.id || '';
                form.nombre.value = clientData.nombre || '';
                form.apellido.value = clientData.apellido || '';
                form.dni.value = clientData.dni || ''; 
                form.correo.value = clientData.correo || '';
                form.telefono.value = clientData.telefono || '';
                form.direccion.value = clientData.direccion || ''; 
                form.referencia.value = clientData.referencia || '';
                form.estado.value = clientData.estado || 'Activo';
                form.querySelectorAll('input[name="tipo_cliente"]').forEach(radio => {
                    radio.checked = (radio.value === clientData.tipo_cliente);
                });
                openModal('modal-editar-cliente');
            }
    
            // --- Cargar Planes para Modal de Edición ---
             async function loadPlansForEditModal() { /* Misma función */ 
                 if (!db) return; 
                 const editPlanSelect = document.getElementById('edit-plan-tipo');
                 if (!editPlanSelect) return; 
                 editPlanSelect.innerHTML = '<option value="">Cargando...</option>';
                 editPlanSelect.disabled = true;
                 const planesRef = collection(db, 'artifacts', appId, 'public', 'data', 'planes');
                 const q = query(planesRef, orderBy("nombre")); 
                 try {
                     const snapshot = await getDocs(q);
                     availablePlans = []; 
                     editPlanSelect.innerHTML = '<option value="">-- Seleccione Plan --</option>';
                     snapshot.forEach((doc) => {
                         const plan = { id: doc.id, ...doc.data() };
                         availablePlans.push(plan); 
                         const option = document.createElement('option');
                         option.value = plan.id; 
                         const suffix = plan.estado !== 'Activo' ? ` (${plan.estado})` : '';
                         option.textContent = `${plan.nombre} (S/ ${parseFloat(plan.precio || 0).toFixed(2)})${suffix}`;
                         option.dataset.price = parseFloat(plan.precio || 0).toFixed(2);
                         if (plan.estado !== 'Activo') option.style.color = '#6c757d'; 
                         editPlanSelect.appendChild(option);
                     });
                     editPlanSelect.disabled = availablePlans.length === 0;
                 } catch (error) {
                     console.error("Error cargando planes para editar:", error);
                     editPlanSelect.innerHTML = '<option value="">Error</option>';
                 }
             }
    
            // --- Lógica Modal Editar Servicio ---
            window.openEditServiceModal = async (clientId, clientName) => { /* Misma función */ 
                 if (!isAuthReady || !db || !userId || !clientId) { showNotification('error', 'Error', 'No se puede editar (falta ID/conexión).'); return; }
                const form = document.getElementById('form-editar-servicio');
                const clientNameDisplay = document.getElementById('edit-servicio-nombre-cliente');
                const currentPriceInput = document.getElementById('edit-precio-plan'); 
                if (!form || !clientNameDisplay || !currentPriceInput) return;
                form.reset(); 
                clientNameDisplay.textContent = clientName || 'N/A'; 
                form.clienteId.value = clientId; 
                const servicesRef = collection(db, 'artifacts', appId, 'public', 'data', 'servicios_clientes');
                const q = query(servicesRef, where("id_cliente", "==", clientId), limit(1)); 
                try {
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) { showNotification('info', 'Info', 'Este cliente no tiene un servicio asociado.'); return; }
                    const serviceDoc = snapshot.docs[0];
                    const serviceData = serviceDoc.data();
                    form.servicioDocId.value = serviceDoc.id; 
                    const planSelectEdit = form.id_plan; // Usa el name para seleccionar
                     if(planSelectEdit){
                         planSelectEdit.value = serviceData.id_plan || ''; 
                         const selectedPlan = availablePlans.find(p => p.id === planSelectEdit.value);
                         currentPriceInput.value = selectedPlan ? parseFloat(selectedPlan.precio || 0).toFixed(2) : '0.00';
                     }
                    form.servicios_adicionales.value = serviceData.servicios_adicionales || 'Ninguno';
                    form.costo_adicional.value = serviceData.costo_adicional || '0.00';
                    form.fecha_inicio.value = serviceData.fecha_inicio || ''; 
                    form.ciclo_facturacion.value = serviceData.ciclo_facturacion || '';
                    form.estado.value = serviceData.estado || 'Activo';
                    form.observaciones.value = serviceData.observaciones || '';
                    openModal('modal-editar-servicio');
                } catch (error) {
                     console.error("Error buscando servicio:", error);
                     showNotification('error', 'Error al Cargar', `No se pudo cargar el servicio: ${error.message}`);
                }
            }
            
            // --- Lógica Eliminar Cliente ---
            window.confirmDeleteClient = (clientId, clientName) => { /* Función simplificada */ 
                if (!modalConfirm || !confirmActionButton) return;
                currentDeleteClientId = clientId; 
                document.getElementById('confirm-title').textContent = 'Confirmar Eliminación';
                document.getElementById('confirm-message').textContent = `¿Seguro que desea eliminar a "${clientName || 'N/A'}" y su servicio asociado? Esta acción no se puede deshacer.`;
                confirmActionButton.onclick = () => deleteClientAndService(currentDeleteClientId); // Asignar directo
                openModal('modal-confirm');
            }
    
            async function deleteClientAndService(clientId) { /* Misma función */ 
                if (!isAuthReady || !db || !userId || !clientId) { 
                     showNotification('error', 'Error', 'No se puede eliminar (falta ID o conexión).'); 
                     closeModal('modal-confirm'); return; 
                }
                closeModal('modal-confirm'); 
                const clientRef = doc(db, 'artifacts', appId, 'public', 'data', 'clientes', clientId);
                try {
                    await deleteDoc(clientRef);
                    console.log("Cliente eliminado:", clientId);
                    const servicesRef = collection(db, 'artifacts', appId, 'public', 'data', 'servicios_clientes');
                    const q = query(servicesRef, where("id_cliente", "==", clientId), limit(1));
                    const serviceSnapshot = await getDocs(q);
                    if (!serviceSnapshot.empty) {
                        const serviceDocId = serviceSnapshot.docs[0].id;
                        const serviceRefToDelete = doc(db, 'artifacts', appId, 'public', 'data', 'servicios_clientes', serviceDocId);
                        await deleteDoc(serviceRefToDelete);
                        console.log("Servicio asociado eliminado:", serviceDocId);
                    } else { console.log("No se encontró servicio asociado."); }
                    showNotification('success', 'Cliente Eliminado', 'El cliente y su servicio asociado fueron eliminados.');
                } catch (error) {
                    console.error("Error al eliminar:", error);
                    showNotification('error', 'Error al Eliminar', `No se pudo eliminar: ${error.message}`);
                } finally { currentDeleteClientId = null; }
            }
            
            // --- Listeners de Formularios y Controles ---
            document.addEventListener('DOMContentLoaded', () => {
                 if (typeof lucide !== 'undefined') lucide.createIcons(); // Iconos generales
                 initSidebar(); // Cargar sidebar y activar su JS
    
                 // Listener para Editar Cliente
                 const formEditClient = document.getElementById('form-editar-cliente');
                 if (formEditClient) formEditClient.addEventListener('submit', async (e) => { /* Misma lógica de antes */ 
                    e.preventDefault(); if (!isAuthReady || !db || !userId) return;
                    const formData = new FormData(formEditClient); const clientId = formData.get('id'); if (!clientId) return;
                    const updatedData = {
                        nombre: formData.get('nombre'), apellido: formData.get('apellido'), dni: formData.get('dni'), correo: formData.get('correo'),
                        telefono: formData.get('telefono'), direccion: formData.get('direccion'), referencia: formData.get('referencia'),
                        estado: formData.get('estado'), tipo_cliente: formEditClient.querySelector('input[name="tipo_cliente"]:checked')?.value // Correcto para radios
                    };
                    const clientRef = doc(db, 'artifacts', appId, 'public', 'data', 'clientes', clientId);
                    try { await updateDoc(clientRef, updatedData); closeModal('modal-editar-cliente'); showNotification('success', 'Cliente Actualizado', 'Datos guardados.'); } 
                    catch (error) { console.error("Error update cliente:", error); showNotification('error', 'Error', `No se pudo actualizar: ${error.message}`); }
                 });
    
                // Listener para Editar Servicio
                const formEditService = document.getElementById('form-editar-servicio');
                 if(formEditService) formEditService.addEventListener('submit', async (e) => { /* Misma lógica de antes */ 
                     e.preventDefault(); if (!isAuthReady || !db || !userId) return;
                     const formData = new FormData(formEditService); const serviceDocId = formData.get('servicioDocId'); if (!serviceDocId) return;
                     const selectedPlanId = formData.get('id_plan'); const selectedPlanData = availablePlans.find(p => p.id === selectedPlanId);
                     const updatedData = {
                         id_plan: selectedPlanId, plan_info: selectedPlanData ? { nombre: selectedPlanData.nombre, precio: parseFloat(selectedPlanData.precio || 0) } : null, 
                         servicios_adicionales: formData.get('servicios_adicionales'), costo_adicional: parseFloat(formData.get('costo_adicional') || 0),
                         fecha_inicio: formData.get('fecha_inicio'), ciclo_facturacion: parseInt(formData.get('ciclo_facturacion') || 15),
                         estado: formData.get('estado'), observaciones: formData.get('observaciones'),
                     };
                     const serviceRef = doc(db, 'artifacts', appId, 'public', 'data', 'servicios_clientes', serviceDocId);
                     try { await updateDoc(serviceRef, updatedData); closeModal('modal-editar-servicio'); showNotification('success', 'Servicio Actualizado', 'Datos guardados.'); } 
                     catch (error) { console.error("Error update servicio:", error); showNotification('error', 'Error', `No se pudo actualizar: ${error.message}`); }
                });
                
                 // Listener para cambio de plan en modal EDITAR servicio
                 const editPlanSelect = document.getElementById('edit-plan-tipo');
                 const editPriceDisplay = document.getElementById('edit-precio-plan');
                 if(editPlanSelect && editPriceDisplay) {
                     editPlanSelect.addEventListener('change', (e) => {
                          const selectedPlanId = e.target.value;
                          const selectedPlan = availablePlans.find(p => p.id === selectedPlanId);
                          editPriceDisplay.value = selectedPlan ? parseFloat(selectedPlan.precio || 0).toFixed(2) : '0.00';
                     });
                 }
    
                 // Listeners para búsqueda y paginación
                 if (searchInput) {
                     searchInput.addEventListener('input', () => {
                         // Podríamos añadir un debounce aquí para no filtrar en cada tecla
                         applyFiltersAndRender();
                     });
                 }
                 if (showEntriesSelect) {
                     showEntriesSelect.addEventListener('change', () => {
                         itemsPerPage = parseInt(showEntriesSelect.value, 10);
                         currentPage = 1; // Volver a la página 1 al cambiar items por página
                         renderCurrentPage();
                     });
                 }
            });
            
    </script>
    <script src="/Cablelatin/public/js/sidebar.js"></script>
    <script src="/Cablelatin/public/js/clientes.js"></script>
    </body>
</html>
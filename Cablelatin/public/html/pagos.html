<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Pagos</title>
    
    <!-- Tailwind CSS para un diseño moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/Cablelatin/public/css/pagos.css">
    
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome (ya lo tenías) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- jsPDF para generar reportes PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF-autoTable para crear tablas fácilmente en el PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100">
    
    <!-- === Sidebar (Placeholder) === -->
    <div id="sidebar-container" class="p-6">
        <h2 class="text-2xl font-bold mb-6">Cablelatin</h2>
        <nav class="flex flex-col space-y-2">
            <a href="#" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-700">
                <i class="fas fa-home w-5 text-center"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-700">
                <i class="fas fa-users w-5 text-center"></i>
                <span>Clientes</span>
            </a>
            <a href="#" class="flex items-center space-x-2 p-2 rounded-lg bg-blue-600 font-semibold">
                <i class="fas fa-file-invoice-dollar w-5 text-center"></i>
                <span>Pagos</span>
            </a>
            <a href="#" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-700">
                <i class="fas fa-cogs w-5 text-center"></i>
                <span>Ajustes</span>
            </a>
        </nav>
    </div>

    <!-- === Contenido Principal === -->
    <main class="main-content">
        
        <!-- === Header (Placeholder) === -->
        <header class="main-navbar bg-white shadow-sm p-4 flex justify-between items-center">
            <h1 class="text-xl font-semibold text-gray-800">Pagos</h1>
            <div class="flex items-center space-x-4">
                <i class="fas fa-bell text-gray-600"></i>
                <i class="fas fa-user-circle text-gray-600 text-2xl"></i>
            </div>
        </header>

        <!-- === Cuerpo del Contenido === -->
        <div class="content-body p-6 lg:p-10">
            
            <!-- Contenedor de la tabla y filtros -->
            <div class="card-table-wrapper bg-white rounded-xl shadow-lg overflow-hidden">

                <!-- Filtros -->
                <div class="table-filters p-6 border-b border-gray-200">
                    <div class="flex flex-col md:flex-row flex-wrap gap-4">
                        <!-- Grupo Desde -->
                        <div class="filter-group flex-1 min-w-[200px]">
                            <label for="date-from" class="block text-sm font-medium text-gray-700 mb-1">Desde</label>
                            <div class="relative">
                                <input type="text" id="date-from" placeholder="dd/mm/aaaa" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <i class="fas fa-calendar-alt absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        <!-- Grupo Hasta -->
                        <div class="filter-group flex-1 min-w-[200px]">
                            <label for="date-to" class="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
                            <div class="relative">
                                <input type="text" id="date-to" placeholder="dd/mm/aaaa" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <i class="fas fa-calendar-alt absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                         <!-- Botón -->
                        <div class="flex-1 min-w-[200px] flex items-end">
                            <button class="btn-primary-filter w-full md:w-auto bg-blue-600 text-white px-5 py-2 rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
                                Mostrar Todo
                            </button>
                        </div>
                        <!-- Búsqueda -->
                        <div class="search-group flex-grow min-w-[250px] flex items-end">
                             <label for="search-table-main" class="sr-only">Buscar</label>
                            <input type="search" id="search-table-main" placeholder="Buscar por documento o ID" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Controles de la Tabla -->
                <div class="table-controls p-6 flex justify-between items-center">
                    <div>
                        <label for="show-entries" class="text-sm text-gray-700">Mostrar</label>
                        <select id="show-entries" name="show-entries" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 ml-2">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                        </select>
                        <span class="ml-2 text-sm text-gray-700">registros</span>
                    </div>
                </div>
                
                <!-- Contenedor de la Tabla -->
                <div class="table-container overflow-x-auto">
                    <table class="w-full min-w-[700px]">
                        <!-- Cabecera de la Tabla -->
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Id</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fecha de Pago</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nº Documento</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Plan</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Precio</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Estado</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Acción</th>
                            </tr>
                        </thead>
                        
                        <!-- Cuerpo de la Tabla (se llenará dinámicamente) -->
                        <tbody id="pagos-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Fila de carga inicial -->
                            <tr>
                                <td colspan="7" class="p-6 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Cargando pagos...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Footer de la Tabla -->
                <div class="table-footer p-6 border-t border-gray-200">
                    <span class="footer-info text-sm text-gray-700" id="table-footer-info">Mostrando 0 de 0 registros</span>
                    <!-- Aquí iría la paginación si se implementara -->
                </div>
            </div>
        </div>
        
    </main>

    <!-- ============================================== -->
    <!--          SCRIPT DE FIREBASE Y LÓGICA           -->
    <!-- ============================================== -->
    <script type="module">
        // --- Importaciones de Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDocs, 
            addDoc, 
            onSnapshot, 
            query,
            limit,
            writeBatch,
            setLogLevel // <-- AÑADIDO PARA DEPURACIÓN
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración Firebase (la que proporcionaste) ---
        const firebaseConfig = {
          apiKey: "AIzaSyDHrAEU4HI2onL1bRZpRfB5GAbsbD6_XBE",
          authDomain: "cablelatin-prueba.firebaseapp.com",
          projectId: "cablelatin-prueba",
          storageBucket: "cablelatin-prueba.firebasestorage.app",
          messagingSenderId: "370823325775",
          appId: "1:370823325775:web:cbd9142e612bc0a979623a",
          measurementId: "G-PV3NRMJBW2"
        };
        
        // --- Variables Globales ---
        const appId = firebaseConfig.projectId;
        let app, auth, db;
        let userId = null;
        let pagosCollectionRef = null;
        
        // --- Referencias a Elementos DOM ---
        const tableBody = document.getElementById('pagos-table-body');
        const tableFooterInfo = document.getElementById('table-footer-info');

        // --- Inicialización Firebase ---
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug'); // <-- AÑADIDO PARA DEPURACIÓN
            console.log("Firebase inicializado:", appId);
            
            // Iniciar autenticación
            initAuth();

        } catch (e) {
            console.error("Error inicializando Firebase:", e);
            if(tableBody) tableBody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-red-600">Error crítico al conectar con Firebase.</td></tr>`;
        }

        // --- Autenticación ---
        function initAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Autenticado (Anónimo):", userId);
                    
                    // --- ¡CAMBIO IMPORTANTE! ---
                    // Apuntamos a la colección PRIVADA del usuario, basándonos en tus otros archivos.
                    // Ruta: artifacts/{appId}/users/{userId}/pagos
                    pagosCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'pagos');
                    
                    console.log("Escuchando en la ruta:", pagosCollectionRef.path); // Log para verificar la ruta

                    // Empezar a escuchar los pagos
                    listenForPayments();

                } else {
                    console.log("No autenticado, intentando anónimo...");
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Error auth anónima:", error);
                        if(tableBody) tableBody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-red-600">Error de autenticación.</td></tr>`;
                    }
                }
            });
        }

        // --- Escuchar y Renderizar Pagos ---
        function listenForPayments() {
            if (!pagosCollectionRef) {
                 console.error("Referencia a 'pagos' no definida.");
                 return;
            }

            // Escuchar cambios en tiempo real
            onSnapshot(pagosCollectionRef, (snapshot) => {
                const pagos = [];
                snapshot.forEach(doc => {
                    pagos.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(`Se encontraron ${pagos.length} pagos en la ruta.`); // Log de depuración
                
                renderTable(pagos); // Renderizar la tabla con los datos
            }, (error) => {
                console.error("Error al escuchar pagos (onSnapshot):", error);
                if(tableBody) tableBody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-red-600">Error al cargar los datos. Revisa los permisos de la base de datos.</td></tr>`;
            });
        }

        // --- Renderizar Tabla (SOLUCIÓN ROBUSTA) ---
        function renderTable(pagos) {
            if (!tableBody || !tableFooterInfo) return;

            tableBody.innerHTML = ''; // Limpiar tabla

            if (pagos.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-gray-500">No se encontraron pagos en esta colección.</td></tr>`;
                tableFooterInfo.textContent = "Mostrando 0 de 0 registros";
                return;
            }

            // (Opcional) Ordenar por fecha, más reciente primero
            // Comprobamos que fecha_pago exista antes de ordenar
            pagos.sort((a, b) => new Date(b.fecha_pago || 0) - new Date(a.fecha_pago || 0));

            pagos.forEach(pago => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50";

                const estadoClass = pago.estado === 'Pagado' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                
                // Usamos innerHTML para las celdas simples
                tr.innerHTML = `
                    <td class="p-4 text-sm text-gray-700">${pago.id.substring(0, 6)}...</td>
                    <td class="p-4 text-sm text-gray-700">${pago.fecha_pago || 'N/A'}</td>
                    <td class="p-4 text-sm text-gray-700">${pago.n_documento || 'N/A'}</td>
                    <td class="p-4 text-sm text-gray-700">${pago.plan_info?.nombre || 'N/A'}</td>
                    <td class="p-4 text-sm text-gray-700">S/ ${parseFloat(pago.plan_info?.precio || 0).toFixed(2)}</td>
                    <td class="p-4 text-sm">
                        <span class="status-pill ${estadoClass} px-3 py-1 rounded-full text-xs font-medium">
                            ${pago.estado || 'N/A'}
                        </span>
                    </td>
                `;

                // --- Creamos la celda de acción y el botón manualmente ---
                const actionCell = document.createElement('td');
                actionCell.className = "p-4 text-sm";
                
                const button = document.createElement('button');
                button.className = "btn-icon text-blue-600 hover:text-blue-800";
                button.title = "Ver Detalle y Generar PDF";
                button.innerHTML = '<i class="fas fa-file-alt"></i>';
                
                // ¡LA MAGIA! Pasamos el objeto 'pago' directamente.
                // Esto evita CUALQUIER error de 'stringify' o sintaxis.
                button.addEventListener('click', () => {
                    window.generarReporte(pago); // Pasamos el objeto, no un string
                });
                
                actionCell.appendChild(button);
                tr.appendChild(actionCell);
                // --- Fin de la creación manual ---
                
                tableBody.appendChild(tr);
            });

            tableFooterInfo.textContent = `Mostrando ${pagos.length} de ${pagos.length} registros`;
        }

        // --- Generar Reporte PDF ---
        // Modificado para aceptar un OBJETO, no un string JSON
        window.generarReporte = (pago) => {
            try {
                // Ya no necesitamos JSON.parse, 'pago' es el objeto
                
                // Inicializar jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                console.log("Generando PDF para:", pago);

                // --- Contenido del PDF ---
                
                // Título
                doc.setFontSize(20);
                doc.setFont("helvetica", "bold");
                doc.text("Comprobante de Pago", 105, 20, { align: "center" });

                // Logo (Placeholder)
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("Cablelatin", 14, 30);
                doc.setFont("helvetica", "normal");
                
                // Línea divisoria
                doc.setLineWidth(0.5);
                doc.line(14, 35, 196, 35);

                // Información del Pago
                doc.setFontSize(11);
                doc.text("ID de Pago:", 14, 45);
                doc.text(pago.id, 50, 45);
                
                doc.text("Fecha de Pago:", 14, 52);
                doc.text(pago.fecha_pago || 'N/A', 50, 52);
                
                doc.text("Nº Documento:", 14, 59);
                doc.text(pago.n_documento || 'N/A', 50, 59);

                doc.text("Estado:", 120, 45);
                doc.setFont("helvetica", "bold");
                doc.text(pago.estado || 'N/A', 140, 45);
                doc.setFont("helvetica", "normal");
                
                // Tabla de Detalles
                const planNombre = pago.plan_info?.nombre || "Plan no especificado";
                const planPrecio = parseFloat(pago.plan_info?.precio || 0).toFixed(2);
                
                doc.autoTable({
                    startY: 70,
                    head: [['Concepto', 'Monto (S/)']],
                    body: [
                        [planNombre, planPrecio],
                    ],
                    theme: 'grid',
                    headStyles: { fillColor: [31, 41, 55] } // Gris oscuro
                });

                // Total
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("TOTAL PAGADO:", 120, finalY);
                doc.text(`S/ ${planPrecio}`, 196, finalY, { align: "right" });

                // Footer
                doc.setFontSize(10);
                doc.setTextColor(150);
                doc.text("Gracias por su preferencia.", 105, 280, { align: "center" });

                // --- Fin Contenido del PDF ---

                // Guardar el archivo
                doc.save(`Comprobante-Pago-${pago.id.substring(0, 6)}.pdf`);

            } catch (error) {
                console.error("Error al generar el PDF:", error);
                // Aquí podrías mostrar un modal de error
            }
        };

    </script>
</body>
</html>
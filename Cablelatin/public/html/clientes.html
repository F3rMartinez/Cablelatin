<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Clientes</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome (para los iconos de la tabla) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Lucide Icons (para los iconos del sidebar) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 
      NOTA: 
      Asegúrate de que esta ruta a tu CSS sea correcta. 
      La dejé tal como la pusiste.
    -->
    <link rel="stylesheet" href="/Cablelatin/public/css/clientes.css">

    <!-- Estilos básicos para el sidebar (mientras carga el CSS) -->
    <style>
        body { display: flex; }
        #sidebar-container {
            width: 250px;
            flex-shrink: 0;
            /* El JS del sidebar manejará el mostrar/ocultar en móvil */
        }
        .main-content {
            flex-grow: 1;
            /* Agrega aquí estilos si es necesario */
        }
    </style>
</head>
<body>
    
    <div id="sidebar-container">
        <!-- El sidebar se cargará aquí -->
    </div>

    <main class="main-content">
        
        <!-- 
          El header (si tienes uno) iría aquí. 
          Tu HTML original tenía una </header> sin un <header> de apertura.
        -->

        <div class="content-body">
            
            <div class="card-table-wrapper">

                <div class="content-header">
                    <h1>Clientes</h1>
                    <!-- CAMBIO: Hice que el botón te lleve a la página de registro -->
                    <a href="registrar_cliente.html" class="btn-primary" title="Añadir Cliente">
                        <i class="fas fa-plus"></i>
                    </a>
                </div>

                <div class="table-controls">
                    <div>
                        <label for="show-entries">Mostrar</label>
                        <select id="show-entries" name="show-entries">
                            <option value="10" selected>10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                        registros
                    </div>
                    <div>
                        <label for="search-table">Buscar:</label>
                        <input type="search" id="search-table" placeholder="Nombre o DNI...">
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Id (Doc)</th>
                                <th>Foto</th>
                                <th>DNI</th>
                                <th>Nombre</th>
                                <th>Teléfono</th>
                                <th>Dirección</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <!-- 
                          CAMBIO: 
                          El <tbody> está vacío. El script de Firebase lo llenará. 
                        -->
                        <tbody id="clients-table-body">
                            <!-- Los clientes de Firebase aparecerán aquí -->
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 20px;">
                                    Cargando clientes...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="table-footer">
                    <span id="footer-info" class="footer-info">Mostrando 0 a 0 de 0 registros</span>
                    <nav class="pagination">
                        <a href="#" class="disabled">Anterior</a>
                        <a href="#" class="active">1</a>
                        <a href="#">Siguiente</a>
                    </nav>
                </div>
            </div>
        </div>
    </main>

    
    <!-- ============================================== -->
    <!--       SCRIPT DE FIREBASE Y TABLA               -->
    <!-- ============================================== -->
    <script type="module">
        // --- Importaciones de Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query,
            onSnapshot // Importamos onSnapshot para tiempo real
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Firebase (Manual) ---
        const firebaseConfig = {
          apiKey: "AIzaSyDHrAEU4HI2onL1bRZpRfB5GAbsbD6_XBE",
          authDomain: "cablelatin-prueba.firebaseapp.com",
          projectId: "cablelatin-prueba",
          storageBucket: "cablelatin-prueba.firebasestorage.app",
          messagingSenderId: "370823325775",
          appId: "1:370823325775:web:cbd9142e612bc0a979623a",
          measurementId: "G-PV3NRMJBW2"
        };
        
        const appId = firebaseConfig.projectId;
        
        let app, auth, db, analytics;
        let userId = null;
        let isAuthReady = false;
        
        // --- Referencia a la tabla ---
        const tableBody = document.getElementById('clients-table-body');
        const footerInfo = document.getElementById('footer-info');

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            analytics = getAnalytics(app);
            console.log("Firebase inicializado con éxito en proyecto:", appId);
        } catch (e) {
            console.error("Error inicializando Firebase:", e);
            if(tableBody) tableBody.innerHTML = `<tr><td colspan="8" style="color: red;">Error al conectar a DB.</td></tr>`;
        }

        // --- Autenticación ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Usuario autenticado:", user.uid);
                userId = user.uid;
                isAuthReady = true;
                
                // *** ¡AQUÍ ES DONDE CARGAMOS LOS CLIENTES! ***
                listenForClients(userId);

            } else {
                console.log("Usuario no autenticado, intentando iniciar sesión anónima...");
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Error en la autenticación anónima:", error);
                    if(tableBody) tableBody.innerHTML = `<tr><td colspan="8" style="color: red;">Error de autenticación.</td></tr>`;
                }
            }
        });

        // --- FUNCIÓN PARA LEER CLIENTES (NUEVO) ---
        function listenForClients(userId) {
            if (!db || !userId) return;

            // Ruta de la colección: artifacts/{appId}/users/{userId}/clientes
            const clientsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'clientes');
            
            // Creamos una consulta
            const q = query(clientsCollectionRef); // (Puedes añadir orderBy aquí si tienes índices)

            console.log("Escuchando cambios en:", clientsCollectionRef.path);

            // onSnapshot se actualiza en tiempo real
            const unsubscribe = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    console.log("No se encontraron clientes.");
                    if(tableBody) tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px;">No hay clientes registrados.</td></tr>`;
                    if(footerInfo) footerInfo.textContent = "Mostrando 0 a 0 de 0 registros";
                    return;
                }

                // Si hay datos, limpiamos la tabla
                if(tableBody) tableBody.innerHTML = '';
                
                let count = 0;
                snapshot.forEach(doc => {
                    count++;
                    const cliente = doc.data();
                    
                    // Creamos la fila de la tabla
                    const row = document.createElement('tr');
                    
                    // Añadimos un data-id para futuras acciones (editar/borrar)
                    row.setAttribute('data-id', doc.id);
                    
                    row.innerHTML = `
                        <td>${doc.id.substring(0, 6)}...</td>
                        <td><div class="user-photo-placeholder"><i class="fas fa-user"></i></div></td>
                        <td>${cliente.dni || 'N/A'}</td>
                        <td>${cliente.nombre || ''} ${cliente.apellido || ''}</td>
                        <td>${cliente.telefono || 'N/A'}</td>
                        <td>${cliente.direccion || 'N/A'}</td>
                        <td><span class="status-pill">${cliente.estado || 'N/A'}</span></td>
                        <td class="table-actions">
                            <button class="btn-icon edit" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn-icon delete" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                    
                    if(tableBody) tableBody.appendChild(row);
                });

                // Actualizamos el pie de tabla
                if(footerInfo) footerInfo.textContent = `Mostrando 1 a ${count} de ${count} registros`;

            }, (error) => {
                console.error("Error al leer clientes (onSnapshot):", error);
                if(tableBody) tableBody.innerHTML = `<tr><td colspan="8" style="color: red;">Error al leer datos: ${error.message}</td></tr>`;
            });

            // (En una app más compleja, guardarías 'unsubscribe' para detener la escucha)
        }


        // --- LÓGICA DEL SIDEBAR (Copiada de registrar_cliente.html) ---
        function initSidebarEvents() {
            const sidebar = document.getElementById('sidebar-container');
            const sidebarToggleMobile = document.getElementById('sidebar-toggle-mobile'); 
            const sidebarToggleMain = document.querySelector('.main-content .sidebar-toggle-btn'); // Asumimos que está en el main
            
            if (!sidebar) return;

            const allNavItems = sidebar.querySelectorAll('.nav-item');
            const menuToggles = sidebar.querySelectorAll('.nav-item.is-parent');
            const nonParentItems = sidebar.querySelectorAll('.nav-item:not(.is-parent)');

            const setAllInactive = () => {
                allNavItems.forEach(item => item.classList.remove('active', 'open'));
                menuToggles.forEach(toggle => {
                    const submenu = toggle.nextElementSibling;
                    if (submenu && submenu.classList.contains('submenu-container')) {
                        submenu.classList.remove('open');
                    }
                    const arrow = toggle.querySelector('.submenu-arrow');
                    if (arrow) arrow.style.transform = 'rotate(0deg)';
                });
            };

            menuToggles.forEach(toggle => {
                toggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (e.target.closest('.submenu-item')) return;
                    const submenu = toggle.nextElementSibling;
                    const arrow = toggle.querySelector('.submenu-arrow');
                    const wasOpen = submenu && submenu.classList.contains('open');
                    setAllInactive(); 
                    if (!wasOpen && submenu) {
                        submenu.classList.add('open');
                        toggle.classList.add('open', 'active'); 
                        if (arrow) arrow.style.transform = 'rotate(90deg)';
                    }
                });
            });

            nonParentItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    setAllInactive();
                    item.classList.add('active');
                    if (window.innerWidth <= 1023 && sidebar) {
                        sidebar.classList.remove('open');
                    }
                });
            });
            
            // ... (Lógica de 'initial-active' omitida por brevedad, pero puedes copiarla si es necesaria) ...

            const toggleSidebar = () => {
                if (sidebar) sidebar.classList.toggle('open');
            };
            
            if (sidebarToggleMobile) sidebarToggleMobile.addEventListener('click', toggleSidebar);
            if (sidebarToggleMain) sidebarToggleMain.addEventListener('click', toggleSidebar);
        }

        // --- Carga del Sidebar y DOM ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar iconos (Lucide para el sidebar, FontAwesome ya está en la tabla)
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // --- Carga el menú lateral ---
            fetch("siderbar.html")
                .then(res => {
                    if (!res.ok) throw new Error('No se encontró sidebar.html'); 
                    return res.text();
                })
                .then(html => {
                    const sidebarContainer = document.getElementById("sidebar-container");
                    if(sidebarContainer) {
                        sidebarContainer.innerHTML = html;
                        initSidebarEvents(); // Inicializa eventos del sidebar
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons({ nodes: [sidebarContainer] }); // Recarga iconos para el sidebar
                        }
                    }
                })
                .catch(err => {
                    console.error("Error al cargar el sidebar:", err);
                    const sidebarContainer = document.getElementById("sidebar-container");
                    if(sidebarContainer) {
                        sidebarContainer.innerHTML = `<p style="color: red; padding: 20px;">Error al cargar menú.</p>`;
                    }
                });
        });

    </script>
</body>
</html>